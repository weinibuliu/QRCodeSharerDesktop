<ui:FluentWindow x:Class="QRCodeSharer.Desktop.Views.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:ui="http://schemas.lepo.co/wpfui/2022/xaml"
        xmlns:vm="clr-namespace:QRCodeSharer.Desktop.ViewModels"
        Title="QRCode Sharer" Width="1000" Height="520"
        MinWidth="650" MinHeight="520"
        WindowStartupLocation="CenterScreen"
        ExtendsContentIntoTitleBar="True"
        WindowBackdropType="Mica">
    
    <Window.DataContext>
        <vm:MainViewModel/>
    </Window.DataContext>

    <Grid>
        <ui:TitleBar Title="QRCode Sharer" Grid.Row="0"/>
        
        <Grid Margin="20,40,20,20">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="Auto"/>
                <ColumnDefinition Width="Auto"/>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="Auto"/>
                <ColumnDefinition Width="Auto"/>
            </Grid.ColumnDefinitions>

            <!-- 左侧：日志区域 -->
            <Border Grid.Column="0" MinWidth="280" MaxWidth="360"
                    Visibility="{Binding ShowLogPanel, Converter={StaticResource BooleanToVisibilityConverter}}">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                    </Grid.RowDefinitions>
                    
                    <StackPanel Orientation="Horizontal" Margin="0,0,0,12">
                        <TextBlock Text="请求日志" FontWeight="SemiBold" FontSize="14" VerticalAlignment="Center"/>
                        <ui:Button Content="清空" Command="{Binding ClearLogsCommand}" Margin="10,0,0,0" 
                                   Appearance="Secondary" Padding="8,4"/>
                    </StackPanel>
                    
                    <Border Grid.Row="1" Background="{ui:ThemeResource ControlFillColorDefaultBrush}" 
                            CornerRadius="4" Padding="8">
                        <ScrollViewer VerticalScrollBarVisibility="Auto">
                            <ItemsControl ItemsSource="{Binding Logs}">
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate DataType="{x:Type vm:LogEntry}">
                                        <Border Padding="4,3" Margin="0,1">
                                            <Grid>
                                                <Grid.ColumnDefinitions>
                                                    <ColumnDefinition Width="75"/>
                                                    <ColumnDefinition Width="90"/>
                                                    <ColumnDefinition Width="35"/>
                                                    <ColumnDefinition Width="Auto"/>
                                                </Grid.ColumnDefinitions>
                                                <TextBlock Grid.Column="0" Text="{Binding Time}" FontSize="10" 
                                                           Opacity="0.6" FontFamily="Consolas"/>
                                                <TextBlock Grid.Column="1" Text="{Binding Request}" FontSize="10" 
                                                           Opacity="0.8" FontFamily="Consolas" Margin="4,0"/>
                                                <TextBlock Grid.Column="2" Text="{Binding StatusCode}" FontSize="10" 
                                                           FontFamily="Consolas"
                                                           Foreground="{Binding IsSuccess, Converter={StaticResource BoolToColorConverter}}"/>
                                                <TextBlock Grid.Column="3" Text="{Binding ElapsedMs}" FontSize="10" 
                                                           FontFamily="Consolas" Margin="8,0,0,0" Opacity="0.6"/>
                                            </Grid>
                                        </Border>
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                            </ItemsControl>
                        </ScrollViewer>
                    </Border>
                </Grid>
            </Border>
            
            <!-- 日志与同步区域分隔线 -->
            <Border Grid.Column="1" Width="1" Background="{ui:ThemeResource ControlStrokeColorDefaultBrush}" 
                    Margin="16,0"
                    Visibility="{Binding ShowLogPanel, Converter={StaticResource BooleanToVisibilityConverter}}"/>

            <!-- 中间：同步区域 -->
            <Grid Grid.Column="2" Margin="10,0">
                <StackPanel HorizontalAlignment="Center" VerticalAlignment="Center">
                    <ui:Button Command="{Binding TogglePollingCommand}"
                               HorizontalAlignment="Center" Padding="16,10" MinWidth="200"
                               Appearance="Primary">
                        <ui:Button.Content>
                            <TextBlock>
                                <TextBlock.Style>
                                    <Style TargetType="TextBlock">
                                        <Setter Property="Text" Value="开始同步"/>
                                        <Style.Triggers>
                                            <DataTrigger Binding="{Binding IsPolling}" Value="True">
                                                <Setter Property="Text" Value="停止同步"/>
                                            </DataTrigger>
                                        </Style.Triggers>
                                    </Style>
                                </TextBlock.Style>
                            </TextBlock>
                        </ui:Button.Content>
                    </ui:Button>
                    
                    <!-- 状态提示 -->
                    <Border Margin="0,12,0,0" MinWidth="180" MinHeight="32"
                            Visibility="{Binding HasStatus, Converter={StaticResource BooleanToVisibilityConverter}}">
                        <ui:InfoBar Title="" Message="{Binding Status}" 
                                    Severity="{Binding InfoBarSeverity}"
                                    IsOpen="{Binding HasStatus}" IsClosable="False"/>
                    </Border>
                    
                    <!-- 二维码区域 -->
                    <Grid Width="320" Height="320" Margin="0,12,0,0">
                        <Image Source="{Binding PlaceholderImage}" Stretch="Uniform" Opacity="0.4">
                            <Image.Style>
                                <Style TargetType="Image">
                                    <Setter Property="Visibility" Value="Collapsed"/>
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding HasContent}" Value="False">
                                            <Setter Property="Visibility" Value="Visible"/>
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </Image.Style>
                            <Image.Effect>
                                <BlurEffect Radius="15"/>
                            </Image.Effect>
                        </Image>
                        <Border Background="{ui:ThemeResource ControlFillColorDefaultBrush}" 
                                CornerRadius="4" Padding="12,6"
                                HorizontalAlignment="Center" VerticalAlignment="Center">
                            <Border.Style>
                                <Style TargetType="Border">
                                    <Setter Property="Visibility" Value="Collapsed"/>
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding HasContent}" Value="False">
                                            <Setter Property="Visibility" Value="Visible"/>
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </Border.Style>
                            <TextBlock Text="等待同步" FontSize="13" Opacity="0.6"/>
                        </Border>
                        <Image Source="{Binding QrCodeImage}" Stretch="Uniform"
                               Visibility="{Binding HasContent, Converter={StaticResource BooleanToVisibilityConverter}}"/>
                    </Grid>
                    
                    <!-- 更新时间 + 复制按钮 -->
                    <StackPanel Margin="0,8,0,0" HorizontalAlignment="Center"
                                Visibility="{Binding HasContent, Converter={StaticResource BooleanToVisibilityConverter}}">
                        <TextBlock Text="{Binding LastUpdateTime}" HorizontalAlignment="Center" 
                                   Opacity="0.6" FontSize="12"/>
                        <ui:Button Content="复制 URL" Command="{Binding CopyContentCommand}"
                                   HorizontalAlignment="Center" Padding="16,8" Margin="0,8,0,0"
                                   Appearance="Secondary"/>
                    </StackPanel>
                </StackPanel>
            </Grid>

            <!-- 分隔线 -->
            <Border Grid.Column="3" Width="1" 
                    Background="{ui:ThemeResource ControlStrokeColorDefaultBrush}" Margin="20,0"/>

            <!-- 右侧：设置区域 -->
            <Grid Grid.Column="4" MinWidth="220">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                </Grid.RowDefinitions>
                
                <TextBlock Grid.Row="0" Text="设置" FontWeight="SemiBold" FontSize="14" Margin="0,0,0,12"/>
                
                <StackPanel Grid.Row="1" IsEnabled="{Binding CanEditSettings}">
                    <TextBlock Text="主机地址" FontSize="12" Opacity="0.6"/>
                    <ui:TextBox Text="{Binding ServerUrl, UpdateSourceTrigger=PropertyChanged}" 
                                PlaceholderText="https://example.com" Margin="0,4,0,0"
                                LostFocus="OnSettingChanged"/>
                    <TextBlock Text="{Binding ServerUrlError}" Foreground="#E81123" FontSize="11" 
                               Visibility="{Binding HasServerUrlError, Converter={StaticResource BooleanToVisibilityConverter}}"
                               Margin="0,2,0,0"/>
                    
                    <TextBlock Text="用户 ID" FontSize="12" Opacity="0.6" Margin="0,10,0,0"/>
                    <ui:TextBox Text="{Binding UserId, UpdateSourceTrigger=PropertyChanged}" 
                                PlaceholderText="你的用户 ID" Margin="0,4,0,0"
                                LostFocus="OnSettingChanged"/>
                    
                    <TextBlock Text="认证密钥" FontSize="12" Opacity="0.6" Margin="0,10,0,0"/>
                    <ui:PasswordBox Password="{Binding AuthKey, UpdateSourceTrigger=PropertyChanged, Mode=TwoWay}" 
                                    PlaceholderText="你的认证密钥" Margin="0,4,0,0"
                                    LostFocus="OnSettingChanged"/>
                    
                    <TextBlock Text="订阅 ID" FontSize="12" Opacity="0.6" Margin="0,10,0,0"/>
                    <ui:TextBox Text="{Binding FollowUserId, UpdateSourceTrigger=PropertyChanged}" 
                                PlaceholderText="要订阅的用户 ID" Margin="0,4,0,0"
                                LostFocus="OnSettingChanged"/>
                    
                    <TextBlock Text="轮询间隔（毫秒）" FontSize="12" Opacity="0.6" Margin="0,10,0,0"/>
                    <ui:TextBox Text="{Binding PollInterval, UpdateSourceTrigger=PropertyChanged}" 
                                Width="100" HorizontalAlignment="Left" Margin="0,4,0,0"
                                LostFocus="OnSettingChanged"/>
                    <TextBlock Text="{Binding PollIntervalError}" Foreground="#E81123" FontSize="11"
                               Visibility="{Binding HasPollIntervalError, Converter={StaticResource BooleanToVisibilityConverter}}"
                               Margin="0,2,0,0"/>
                    
                    <TextBlock Text="连接超时（毫秒）" FontSize="12" Opacity="0.6" Margin="0,10,0,0"/>
                    <ui:TextBox Text="{Binding Timeout, UpdateSourceTrigger=PropertyChanged}" 
                                Width="100" HorizontalAlignment="Left" Margin="0,4,0,0"
                                LostFocus="OnSettingChanged"/>
                    
                    <ui:Button Content="测试连接" Command="{Binding TestConnectionCommand}" 
                               Margin="0,16,0,0" Padding="16,8" HorizontalAlignment="Stretch"
                               HorizontalContentAlignment="Center"
                               IsEnabled="{Binding CanEditSettings}" Appearance="Primary"/>
                </StackPanel>
            </Grid>
        </Grid>
    </Grid>
</ui:FluentWindow>
